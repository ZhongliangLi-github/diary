<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>二、使用MIG和Kubernetes大规模部署NVIDIA Triton &mdash; SpinxDemo v1.0 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="验收集群" href="03%E4%BD%BF%E7%94%A8Kubernetes%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4.html" />
    <link rel="prev" title="一、kubernetes安装" href="01%E5%9C%A8Ubuntu18.04%E4%B8%8A%E6%90%AD%E5%BB%BAkubernetes.html" />
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SpinxDemo
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">学习笔记</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01Docker/index.html">Docker</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Triton_with_kubernetes</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="01%E5%9C%A8Ubuntu18.04%E4%B8%8A%E6%90%AD%E5%BB%BAkubernetes.html">一、kubernetes安装</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">二、使用MIG和Kubernetes大规模部署NVIDIA Triton</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#create-a-kubernetes-deployment-for-triton-inference-servers">1、Create a Kubernetes Deployment for Triton Inference Servers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-a-kubernetes-service-for-triton-inference-servers">2、Create a Kubernetes Service for Triton Inference Servers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prometheusnvidia">3、使用Prometheus爬取NVIDIA的性能</a></li>
<li class="toctree-l4"><a class="reference internal" href="#autoscale-triton-inference-servers">4、Autoscale Triton Inference Servers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hpa">5、部署HPA</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nginx-plus">6、使用NGINX Plus负载均衡</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="03%E4%BD%BF%E7%94%A8Kubernetes%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4.html">验收集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="03%E4%BD%BF%E7%94%A8Kubernetes%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4.html#nginx">正式部署NGINX集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="03%E4%BD%BF%E7%94%A8Kubernetes%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4.html#dashboard">部署Dashboard</a></li>
<li class="toctree-l3"><a class="reference internal" href="05Grafana.html">Grafana</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SpinxDemo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">学习笔记</a></li>
          <li class="breadcrumb-item"><a href="index.html">Triton_with_kubernetes</a></li>
      <li class="breadcrumb-item active">二、使用MIG和Kubernetes大规模部署NVIDIA Triton</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/学习笔记/02Triton_with_kubernetes/02使用MIG和Kubernetes大规模部署NVIDIA Triton.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="migkubernetesnvidia-triton">
<h1>二、使用MIG和Kubernetes大规模部署NVIDIA Triton<a class="headerlink" href="#migkubernetesnvidia-triton" title="此标题的永久链接"></a></h1>
<p>​	docker版本：20.10.21</p>
<p>​	k8s版本：1.21.3</p>
<p>​	多实例GPU(multi-instance GPU, MIG)可以通过并行运行多个工作负载，最大限度提高RTX 3090 Ti GPU利用率，MIG功能可以将单个GPU划分为多个称为GPU实例的GPU分区，每个分区有专用的内存和计算资源，因此硬件级隔离可确保同时运行工作负载，同时保证服务质量和故障隔离。</p>
<ul class="simple">
<li><p>在RTX 3090 Ti上使用MIG并行部署多个Triton推理服务器</p></li>
<li><p>使用Kubernetes和Prometheus监控堆栈，根据推理请求的数量自动扩展Triton推理服务器的数量</p></li>
<li><p>使用NGINX PLUS负载均衡器在不同的Triton推理服务器之间平均分配推理负载</p></li>
</ul>
<p>扩展到Kubernetest环境中部署，可以根据推理请求自动调整Triton推理服务器的数量，并且推理负载能够分布在所有服务器之间，实现负载均衡。</p>
<section id="create-a-kubernetes-deployment-for-triton-inference-servers">
<h2>1、Create a Kubernetes Deployment for Triton Inference Servers<a class="headerlink" href="#create-a-kubernetes-deployment-for-triton-inference-servers" title="此标题的永久链接"></a></h2>
<p>​	第一步是为Triton推理服务器创建Kubernetes部署。部署为Pods和ReplicaSet提供声明性更新。Kubernetes中的ReplicaSet同时启动同一Pod的多个实例。</p>
<p>​	以下文件创建了三个replicated Pods，每个Pod运行一个名为speech的容器，该容器运行wenet_server:22.03版本Triton推理服务器镜像，与NVIDIA Triton端口号相同，容器端口8000、8001、8002分别为HTTP、gRPC和NVIDIA Triton metrics</p>
<p>​	使用混合策略为一个5G MIG设备分配给每个Pod。如果没有共享文件系统，则必须确保将模型加载到所有工作节点，以便Kubernetes启动的Pods可以访问</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">speech</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="mi">2</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">dshm</span>
        <span class="n">emptyDir</span><span class="p">:</span>
          <span class="n">medium</span><span class="p">:</span> <span class="n">Memory</span>
          <span class="n">sizeLimit</span><span class="p">:</span> <span class="mi">2048</span><span class="n">Mi</span>
      <span class="n">containers</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">speech</span>
          <span class="n">ports</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="mi">8000</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">http</span><span class="o">-</span><span class="n">triton</span>
          <span class="o">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="mi">8001</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">grpc</span><span class="o">-</span><span class="n">triton</span>
          <span class="o">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="mi">8002</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">triton</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">wenet_server</span><span class="p">:</span><span class="mf">22.03</span>
          <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/bin/bash&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">]</span>
          <span class="n">args</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bash /workspace/infer.sh&quot;</span><span class="p">]</span>
          <span class="n">volumeMounts</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span>
              <span class="n">name</span><span class="p">:</span> <span class="n">dshm</span>
</pre></div>
</div>
<p>​	使用kuberctl apply创建Kubernetes部署</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">speech</span><span class="o">-</span><span class="n">replicas2</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>显示</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">deployment</span><span class="o">.</span><span class="n">apps</span><span class="o">/</span><span class="n">speech</span> <span class="n">created</span>
</pre></div>
</div>
<section id="id1">
<h3>出现问题<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h3>
<p>查看pods，发现状态为Pending</p>
<p><img alt="image-20230320112006623" src="../../_images/image-20230320112006623.png" /></p>
<p>查看具体原因执行</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">kubectl</span> <span class="n">describe</span> <span class="n">pod</span> <span class="n">speech</span><span class="o">-</span><span class="mi">677</span><span class="n">b4999cf</span><span class="o">-</span><span class="mi">9</span><span class="n">nsrq</span>
</pre></div>
</div>
<p><img alt="image-20230320111921236" src="../../_images/image-20230320111921236.png" /></p>
<section id="id2">
<h4>解决方案1<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h4>
<p><a class="reference external" href="https://blog.csdn.net/weixin_43114954/article/details/119153903">(70条消息) 0/1 nodes are available: 1 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn‘t_YuanOo。的博客-CSDN博客</a></p>
<p>​	原因：当创建单机版的 k8s 时，这个时候 master 节点是默认不允许调度 pod</p>
<p>将master标记为可调度即可</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">taint</span> <span class="n">nodes</span> <span class="o">--</span><span class="nb">all</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span><span class="o">-</span>
</pre></div>
</div>
</section>
</section>
<section id="deployment">
<h3>删除Deployment命令<a class="headerlink" href="#deployment" title="此标题的永久链接"></a></h3>
<p>​	若要重新apply YAML文件，需要删除之间部署的speech</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">delete</span> <span class="n">deployment</span> <span class="n">speech</span>
</pre></div>
</div>
</section>
</section>
<section id="create-a-kubernetes-service-for-triton-inference-servers">
<h2>2、Create a Kubernetes Service for Triton Inference Servers<a class="headerlink" href="#create-a-kubernetes-service-for-triton-inference-servers" title="此标题的永久链接"></a></h2>
<p>​	第二步是创建一个Kubernetes服务，将Triton推理服务器作为网络服务公开。创建服务时，使用Type字段选择自动创建外部负载均衡选项，其提供了一个外部可访问的IP地址，用于将流量发送到节点上的正确端口：</p>
<p>speech-service.yml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">speech</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="p">:</span> <span class="mi">8000</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="mi">8000</span>
    <span class="o">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="p">:</span> <span class="mi">8001</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">grpc</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="mi">8001</span>
    <span class="o">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="p">:</span> <span class="mi">8002</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="mi">8002</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">LoadBalancer</span> 
</pre></div>
</div>
<p>​	使用如下命令创建Kubernetes服务</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">speech</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p><img alt="image-20230321113735206" src="../../_images/image-20230321113735206.png" /></p>
<p>​	验证服务创建成功</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">svc</span>
</pre></div>
</div>
<p><img alt="image-20230321113857175" src="../../_images/image-20230321113857175.png" /></p>
<p>现在，Triton推理服务器已准备好接收来自远程客户端的推理请求，如果客户端发送推理请求，则客户端可以查看语音识别的结果。10.24.83.40: 30869</p>
<p><img alt="image-20230321122629260" src="../../_images/image-20230321122629260.png" /></p>
<p>至此，多个Triton推理服务器在Kubernetes环境中运行，对客户端发送的语音进行推理，可以手动更改服务器的数量。在接下来的部分中，对其进行改进，以便可以根据客户端请求自动调整服务器的数量。</p>
</section>
<section id="prometheusnvidia">
<h2>3、使用Prometheus爬取NVIDIA的性能<a class="headerlink" href="#prometheusnvidia" title="此标题的永久链接"></a></h2>
<p>​	要自动更改Kubernetest Pods上Trition推理服务器的数量，首先收集用于自定义度量NVIDIA Triton性能，因为有来自多个Kubernetes Pods下的NVIDIA Triton指标，所以需要部署一个PodMonitor，告诉Prometheus从所有的Pods中收集指标。</p>
<p>​	Prometheus是一款开源的系统监控和报警工具包，提供由度量名称键值对标识的时间序列数据。PromQL是一种灵活的查询语言，用于查询Prometheus的度量。</p>
<section id="create-podmonitor-for-prometheus">
<h3>3.1	Create PodMonitor for Prometheus<a class="headerlink" href="#create-podmonitor-for-prometheus" title="此标题的永久链接"></a></h3>
<p>​	在<code class="docutils literal notranslate"><span class="pre">speech-pod-monitor.yml</span></code>文件中，定义一个PodMonitor来监视服务器的pod，如spec.selector字段所示，还需要kube-prometheus，包括prometheus的部署，并抓取链接到Prometheus各种度量端点的目标配置，如spec.podMetricsEndpoints字段所示，Prometheus每隔10s从这些端点抓取NVIDIA Triton指标：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">monitoring</span><span class="o">.</span><span class="n">coreos</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">PodMonitor</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">prometheus</span><span class="o">-</span><span class="n">stack</span><span class="o">-</span><span class="n">tritonmetrics</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
  <span class="n">labels</span><span class="p">:</span>
      <span class="n">prometheus</span><span class="p">:</span> <span class="n">k8s</span>
<span class="n">spec</span><span class="p">:</span>
   <span class="n">selector</span><span class="p">:</span>
      <span class="n">matchLabels</span><span class="p">:</span>
         <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
   <span class="n">namespaceSelector</span><span class="p">:</span>
      <span class="n">matchNames</span><span class="p">:</span>
         <span class="o">-</span> <span class="n">default</span>
   <span class="n">podMetricsEndpoints</span><span class="p">:</span>
   <span class="o">-</span> <span class="n">port</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">triton</span>
     <span class="n">interval</span><span class="p">:</span> <span class="mi">10</span><span class="n">s</span>
     <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">metrics</span>
</pre></div>
</div>
<p>要匹配NVIDIA Triton Deployment的标签，确保<code class="docutils literal notranslate"><span class="pre">spec.selector.matchLabels</span></code>字段为<code class="docutils literal notranslate"><span class="pre">app:</span> <span class="pre">speech</span></code>，<code class="docutils literal notranslate"><span class="pre">spec.namespaceSelector.matchNames</span></code>字段为<code class="docutils literal notranslate"><span class="pre">-default</span></code>，两者都应与NVIDIA Triton Deployment位于同一命名空间下。</p>
<p>使用命令<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">apply</span> <span class="pre">-f</span> <span class="pre">speech-pod-monitor.yml</span></code>并验证</p>
<p><img alt="image-20230321154541639" src="../../_images/image-20230321154541639.png" /></p>
<section id="prometheus">
<h4>安装Prometheus<a class="headerlink" href="#prometheus" title="此标题的永久链接"></a></h4>
<p>下载地址：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">prometheus</span><span class="o">-</span><span class="n">operator</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">prometheus</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">tags</span><span class="o">/</span><span class="n">v0</span><span class="mf">.9.0</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</pre></div>
</div>
<p>解压后，执行</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">manifests</span><span class="o">/</span><span class="n">setup</span>
<span class="n">until</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">servicemonitors</span> <span class="o">--</span><span class="nb">all</span><span class="o">-</span><span class="n">namespaces</span> <span class="p">;</span> <span class="n">do</span> <span class="n">date</span><span class="p">;</span> <span class="n">sleep</span> <span class="mi">1</span><span class="p">;</span> <span class="n">echo</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="n">done</span>
<span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">manifests</span><span class="o">/</span>
</pre></div>
</div>
<p>删除指令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">delete</span> <span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="ow">not</span><span class="o">-</span><span class="n">found</span><span class="o">=</span><span class="n">true</span> <span class="o">-</span><span class="n">f</span> <span class="n">manifests</span><span class="o">/</span> <span class="o">-</span><span class="n">f</span> <span class="n">manifests</span><span class="o">/</span><span class="n">setup</span>
</pre></div>
</div>
<p>验证：</p>
<p><img alt="image-20230321154509028" src="../../_images/image-20230321154509028.png" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">monitoring</span> <span class="n">port</span><span class="o">-</span><span class="n">forward</span> <span class="n">svc</span><span class="o">/</span><span class="n">prometheus</span><span class="o">-</span><span class="n">k8s</span> <span class="mi">9090</span>
</pre></div>
</div>
</section>
<section id="id3">
<h4>两个镜像<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h4>
<p>1、kube-state-metrics</p>
<p>位于manifests/kube-state-metrics-deployment.yaml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">registry</span><span class="o">.</span><span class="n">cn</span><span class="o">-</span><span class="n">hangzhou</span><span class="o">.</span><span class="n">aliyuncs</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">chenby</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">state</span><span class="o">-</span><span class="n">metrics</span><span class="p">:</span><span class="n">v2</span><span class="mf">.1.1</span>
</pre></div>
</div>
<p>2、prometheus-adapter</p>
<p>位于manifests/prometheus-adapter-deployment.yaml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">registry</span><span class="o">.</span><span class="n">cn</span><span class="o">-</span><span class="n">hangzhou</span><span class="o">.</span><span class="n">aliyuncs</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">chenby</span><span class="o">/</span><span class="n">prometheus</span><span class="o">-</span><span class="n">adapter</span><span class="p">:</span><span class="n">v0</span><span class="mf">.9.0</span>
</pre></div>
</div>
</section>
<section id="prometheusgrafana">
<h4>暴露prometheus和grafana端口<a class="headerlink" href="#prometheusgrafana" title="此标题的永久链接"></a></h4>
<p>目录：manifests/prometheus-service.yaml，端口映射到32101</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">component</span><span class="p">:</span> <span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">name</span><span class="p">:</span> <span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">part</span><span class="o">-</span><span class="n">of</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">version</span><span class="p">:</span> <span class="mf">2.29.1</span>
    <span class="n">prometheus</span><span class="p">:</span> <span class="n">k8s</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">prometheus</span><span class="o">-</span><span class="n">k8s</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">web</span>
    <span class="n">port</span><span class="p">:</span> <span class="mi">9090</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="n">web</span>
    <span class="n">nodePort</span><span class="p">:</span> <span class="mi">32101</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">component</span><span class="p">:</span> <span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">name</span><span class="p">:</span> <span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">part</span><span class="o">-</span><span class="n">of</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">prometheus</span>
    <span class="n">prometheus</span><span class="p">:</span> <span class="n">k8s</span>
  <span class="n">sessionAffinity</span><span class="p">:</span> <span class="n">ClientIP</span>
</pre></div>
</div>
<p>目录：manifests/grafana-service.yaml，端口映射到32102</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">component</span><span class="p">:</span> <span class="n">grafana</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">name</span><span class="p">:</span> <span class="n">grafana</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">part</span><span class="o">-</span><span class="n">of</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">version</span><span class="p">:</span> <span class="mf">8.1.1</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">grafana</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
    <span class="n">port</span><span class="p">:</span> <span class="mi">3000</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="n">http</span>
    <span class="n">nodePort</span><span class="p">:</span> <span class="mi">32102</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">component</span><span class="p">:</span> <span class="n">grafana</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">name</span><span class="p">:</span> <span class="n">grafana</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">part</span><span class="o">-</span><span class="n">of</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">prometheus</span>
</pre></div>
</div>
</section>
</section>
<section id="prometheusnvidia-triton">
<h3>3.2	使用Prometheus查询NVIDIA Triton 指标<a class="headerlink" href="#prometheusnvidia-triton" title="此标题的永久链接"></a></h3>
<p>​	默认情况下，Prometheus附带了一个用户界面，可以在Prometheus服务器9090号端口访问，地址是http://10.24.83.40:30503/</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">avg</span><span class="p">(</span><span class="n">delta</span><span class="p">(</span><span class="n">nv_inference_queue_duration_us</span><span class="p">[</span><span class="mi">30</span><span class="n">s</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">delta</span><span class="p">(</span><span class="n">nv_inference_request_success</span><span class="p">[</span><span class="mi">30</span><span class="n">s</span><span class="p">])))</span>
</pre></div>
</div>
</section>
</section>
<section id="autoscale-triton-inference-servers">
<h2>4、Autoscale Triton Inference Servers<a class="headerlink" href="#autoscale-triton-inference-servers" title="此标题的永久链接"></a></h2>
<p>​	Prometheus在监视服务器，接下来部署Prometheus适配器，它知道如何与Kubernetes和Prometheus通信，适配器能够使用Prometheus收集的指标作出缩放决策。</p>
<section id="create-configmap-to-define-the-custom-metric">
<h3>4.1	Create ConfigMap to define the custom metric<a class="headerlink" href="#create-configmap-to-define-the-custom-metric" title="此标题的永久链接"></a></h3>
<p>​	首先需要告诉Prometheus如何收集特定的度量，在ConfigMap中自定义平均等待时间<code class="docutils literal notranslate"><span class="pre">avg_time_queue_us</span></code>度量，<code class="docutils literal notranslate"><span class="pre">nv_inference_request_success[30]</span></code>定义了过去30s成功推理请求数目，<code class="docutils literal notranslate"><span class="pre">nv_inference_quene_duration_us</span></code>定义了以微秒为单位的累计排队持续时间。</p>
<p>​	自定义度量指过去30s每个推理请求的平均队列时间，HPA根据该时间决定是否改变replicas数目。</p>
<p>​	度量需要有一个endpoint，未编址的度量无法从度量API查询，添加<code class="docutils literal notranslate"><span class="pre">.overrides</span></code>字段，强制pod和namespaces之后在API中分开</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">adapter</span><span class="o">-</span><span class="n">config</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">triton</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span> <span class="o">|</span>
    <span class="n">rules</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">seriesQuery</span><span class="p">:</span> <span class="s1">&#39;nv_inference_queue_duration_us{namespace=&quot;default&quot;,pod!=&quot;&quot;}&#39;</span>
      <span class="n">resources</span><span class="p">:</span>
        <span class="n">overrides</span><span class="p">:</span>
          <span class="n">namespace</span><span class="p">:</span>
            <span class="n">resource</span><span class="p">:</span> <span class="s2">&quot;namespace&quot;</span>
          <span class="n">pod</span><span class="p">:</span>
            <span class="n">resource</span><span class="p">:</span> <span class="s2">&quot;pod&quot;</span>
      <span class="n">name</span><span class="p">:</span>
        <span class="n">matches</span><span class="p">:</span> <span class="s2">&quot;nv_inference_queue_duration_us&quot;</span>
        <span class="k">as</span><span class="p">:</span> <span class="s2">&quot;avg_time_queue_us&quot;</span>
      <span class="n">metricsQuery</span><span class="p">:</span> <span class="s1">&#39;avg(delta(nv_inference_queue_duration_us[30s])/(1+delta(nv_inference_request_success[30s]))) by (&lt;&lt;.GroupBy&gt;&gt;)&#39;</span>
</pre></div>
</div>
<p>执行</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>出现</p>
<p><img alt="image-20230321204503467" src="../../_images/image-20230321204503467.png" /></p>
</section>
<section id="kubernetes-metrcs-apiprometheus-adapter">
<h3>4.2	为Kubernetes metrcs API创建Prometheus adapter<a class="headerlink" href="#kubernetes-metrcs-apiprometheus-adapter" title="此标题的永久链接"></a></h3>
<p>​	首先：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="n">clusterrolebinding</span> <span class="n">permissive</span><span class="o">-</span><span class="n">binding</span> <span class="o">--</span><span class="n">clusterrole</span><span class="o">=</span><span class="n">cluster</span><span class="o">-</span><span class="n">admin</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">admin</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">kubelet</span> <span class="o">--</span><span class="n">group</span><span class="o">=</span><span class="n">system</span><span class="p">:</span><span class="n">serviceaccounts</span> 
</pre></div>
</div>
<p>​	为了使HPA对这个自定义度量做出反应，必须为Prometheus Adapter创建Deployment、Service、APIService，以下是部署文件custom-metrics-server-Deployment.yml。其使用ConfigMap告诉适配器收集自定义度量，创建Deployment，adapter Pod提取自定义度量。containers.config字段必须与.mountPath字段和上一步在ConfigMap中创建的文件名triton-adapter-config.yml匹配。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">apiserver</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metris</span><span class="o">-</span><span class="n">apiserver</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">apiserver</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">apiserver</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">quay</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">coreos</span><span class="o">/</span><span class="n">k8s</span><span class="o">-</span><span class="n">prometheus</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">amd64</span><span class="p">:</span><span class="n">v0</span><span class="mf">.8.0</span>
        <span class="n">args</span><span class="p">:</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">cert</span><span class="o">-</span><span class="nb">dir</span><span class="o">=/</span><span class="n">tmp</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">prometheus</span><span class="o">-</span><span class="n">url</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.24.83.40</span><span class="p">:</span><span class="mi">30503</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">metrics</span><span class="o">-</span><span class="n">relist</span><span class="o">-</span><span class="n">interval</span><span class="o">=</span><span class="mi">30</span><span class="n">s</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">v</span><span class="o">=</span><span class="mi">10</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">config</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">triton</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">yml</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">secure</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">6443</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">main</span><span class="o">-</span><span class="n">port</span>
          <span class="n">containerPort</span><span class="p">:</span> <span class="mi">6443</span>
        <span class="n">volumeMounts</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">config</span><span class="o">-</span><span class="n">volume</span>
          <span class="n">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">config</span>
          <span class="n">readOnly</span><span class="p">:</span> <span class="n">false</span>
      <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">config</span><span class="o">-</span><span class="n">volume</span>
        <span class="n">configMap</span><span class="p">:</span>
          <span class="n">name</span><span class="p">:</span> <span class="n">adapter</span><span class="o">-</span><span class="n">config</span>
</pre></div>
</div>
<p><img alt="image-20230322203935105" src="../../_images/image-20230322203935105.png" /></p>
<p>接下来创建<code class="docutils literal notranslate"><span class="pre">custom-metrics-server-service.yml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">api</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">apiserver</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">port</span><span class="p">:</span> <span class="mi">443</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="mi">6443</span> 
</pre></div>
</div>
<p>接下来，创建一个APIService，以便Kubernetes可以访问Prometheus adapter。以下是文件<code class="docutils literal notranslate"><span class="pre">custom-metrics-server-apiservice.yml</span></code>，.spec.service字段必须与Service文件的.metadata字段匹配，为了允许自动缩放器访问自定义度量，需要向API aggregator注册该metrics，需要使用的API是custom.metrics.k8s.io/v1beta1</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">apiregistration</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">APIService</span>
<span class="n">metadata</span><span class="p">:</span>
   <span class="n">name</span><span class="p">:</span> <span class="n">v1beta1</span><span class="o">.</span><span class="n">custom</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span>
<span class="n">spec</span><span class="p">:</span>
   <span class="n">insecureSkipTLSVerify</span><span class="p">:</span> <span class="n">true</span>
   <span class="n">group</span><span class="p">:</span> <span class="n">custom</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span>
   <span class="n">groupPriorityMinimum</span><span class="p">:</span> <span class="mi">100</span>
   <span class="n">versionPriority</span><span class="p">:</span> <span class="mi">5</span>
   <span class="n">service</span><span class="p">:</span>
     <span class="n">name</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">api</span>
     <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
   <span class="n">version</span><span class="p">:</span> <span class="n">v1beta1</span>
</pre></div>
</div>
<p>​	使用命令kubectl apply来应用三个前面提到的.yml文件配置，为Prometheus创建API Service之后，可以看到custom metrics可用：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="o">--</span><span class="n">raw</span> <span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">custom</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1beta1</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">.</span>
</pre></div>
</div>
<p><img alt="image-20230327192343568" src="../../_images/image-20230327192343568.png" /></p>
<p>还可以检查custom metrics的当前值，该值为0表示没有来自客户端的推理请求，default namespace选择所有pod，其中部署了speech-demo：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="o">--</span><span class="n">raw</span> <span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">custom</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1beta1</span><span class="o">/</span><span class="n">namespaces</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">pods</span><span class="o">/*/</span><span class="n">avg_time_queue_us</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">.</span>
</pre></div>
</div>
<p><img alt="image-20230327192704313" src="../../_images/image-20230327192704313.png" /></p>
</section>
</section>
<section id="hpa">
<h2>5、部署HPA<a class="headerlink" href="#hpa" title="此标题的永久链接"></a></h2>
<p>​	现在可以创建一个用于自定义度量的HPA，HPA可以根据观察到的指标自动缩放复制器中Pods的数量。HPA根据监测值和当前值的比率来控制Kubernetes中replicas Pods的数量。
$$
R = ceil(CR \cdot \frac{CV}{DV})
$$
$R$表示Kubernetes拥有replicas的数量；$CR$是当前replicas pod的数量；$CV$是当前的metrics，表示来自所有servers的自定义度量的平均值；$DV$是所需的度量值。当$R$与$CR$不同时，HPA可以增加或减少replicas的数量。</p>
<p>​	以下HPA文件<code class="docutils literal notranslate"><span class="pre">speech-HPA.yml</span></code>可以自动缩放Triton推理服务器的部署，使用<code class="docutils literal notranslate"><span class="pre">.spec.targetAverageValue</span></code>字段所需的度量值。该字段定期调整pods的数量，以使观察到的自定义度量与目标值匹配。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">autoscaling</span><span class="o">/</span><span class="n">v2beta1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">HorizontalPodAutoscaler</span>
<span class="n">metadata</span><span class="p">:</span>
   <span class="n">name</span><span class="p">:</span> <span class="n">speech</span><span class="o">-</span><span class="n">hpa</span>
<span class="n">spec</span><span class="p">:</span>
   <span class="n">scaleTargetRef</span><span class="p">:</span>
     <span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1beta1</span>
     <span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
     <span class="n">name</span><span class="p">:</span> <span class="n">speech</span>
   <span class="n">minReplicas</span><span class="p">:</span> <span class="mi">1</span>
   <span class="n">maxReplicas</span><span class="p">:</span> <span class="mi">3</span>
   <span class="n">metrics</span><span class="p">:</span>
   <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Pods</span>
     <span class="n">pods</span><span class="p">:</span>
       <span class="n">metricName</span><span class="p">:</span> <span class="n">avg_time_queue_us</span>
       <span class="n">targetAverageValue</span><span class="p">:</span> <span class="mi">10000</span>
</pre></div>
</div>
<p>可以查看部署的HPA状态：</p>
<p><img alt="image-20230327200937175" src="../../_images/image-20230327200937175.png" /></p>
<p>如果客户端向服务器发送推理请求，则新的HPA可以获取部署的自定义度量，并建立所需Pod的数量，当客户端停止发送推理请求时，HPA将replicas数量减少到只有1。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">hpa</span>

<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">hpa</span> <span class="n">speech</span><span class="o">-</span><span class="n">hpa</span>
</pre></div>
</div>
<p><img alt="image-20230327203412462" src="../../_images/image-20230327203412462.png" /></p>
</section>
<section id="nginx-plus">
<h2>6、使用NGINX Plus负载均衡<a class="headerlink" href="#nginx-plus" title="此标题的永久链接"></a></h2>
<p>​	负载均衡是为了在可用的服务器之间以最佳方式分配来自客户端的负载。NGINX Plus作为高级7层负载均衡</p>
<p>​	在该demo中，使用Prometheus，通过autoscaler新添加的Pods无法使用Kubernetes内置的负载均衡器获得工作负载。使用NGINX Plus，它是第七层（应用层）负载均衡器，工作负载均匀分布在所有Pods中，包括新扩展的Pod。</p>
<p>​	首先需要创建一个NGINX镜像，因为Dockerhub无法提供NGINX Plus商业产品。使用Docker Hub中的NGINX开源镜像在Docker容器中创建一个NGINX实例，然后将本地镜像推送到一个专用的Docker注册表中。</p>
<p>​	接下来，要部署NGINX Plus，使用以下命令将要部署NGINX Plus的节点标记为<code class="docutils literal notranslate"><span class="pre">role=nginxplus</span></code>：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">label</span> <span class="n">node</span> <span class="n">xmdx</span> <span class="n">role</span><span class="o">=</span><span class="n">nginxplus</span>
</pre></div>
</div>
<p><img alt="image-20230403111341595" src="../../_images/image-20230403111341595.png" /></p>
<p>​	修改Service将Cluster IP设置为None，暴露并标识所有的replicas端点。创建一个新的Service文件<code class="docutils literal notranslate"><span class="pre">speech-service-nginx.yml</span></code>，并且apply it：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">speech</span><span class="o">-</span><span class="n">nginx</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
<span class="n">Spec</span><span class="p">:</span>
  <span class="n">clusterIP</span><span class="p">:</span> <span class="kc">None</span> 
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="p">:</span> <span class="mi">8000</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="mi">8000</span>
    <span class="o">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="p">:</span> <span class="mi">8001</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">grpc</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="mi">8001</span> 
</pre></div>
</div>
<p>​	现在，为NGINX创建一个配置文件，位于<code class="docutils literal notranslate"><span class="pre">/path/to/nginx/config/nginx.conf</span></code>。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resolver</span> <span class="mf">10.96.0.10</span> <span class="n">valid</span><span class="o">=</span><span class="mi">5</span><span class="n">s</span><span class="p">;</span>
<span class="n">upstream</span> <span class="n">backend</span> <span class="p">{</span>
   <span class="n">zone</span> <span class="n">upstream</span><span class="o">-</span><span class="n">backend</span> <span class="mi">64</span><span class="n">k</span><span class="p">;</span>
   <span class="n">server</span> <span class="n">speech</span><span class="o">-</span><span class="n">nginx</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">svc</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">local</span><span class="p">:</span><span class="mi">8000</span> <span class="n">resolve</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">upstream</span> <span class="n">backendgrpc</span> <span class="p">{</span>
   <span class="n">zone</span> <span class="n">upstream</span><span class="o">-</span><span class="n">backend</span> <span class="mi">64</span><span class="n">k</span><span class="p">;</span>
   <span class="n">server</span> <span class="n">speech</span><span class="o">-</span><span class="n">nginx</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">svc</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">local</span><span class="p">:</span><span class="mi">8001</span> <span class="n">resolve</span><span class="p">;</span>
<span class="p">}</span>
  
<span class="n">server</span> <span class="p">{</span>
   <span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>
   <span class="n">status_zone</span> <span class="n">backend</span><span class="o">-</span><span class="n">servers</span><span class="p">;</span>
  
   <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
     <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">backend</span><span class="p">;</span>
     <span class="n">health_check</span> <span class="n">uri</span><span class="o">=/</span><span class="n">v2</span><span class="o">/</span><span class="n">health</span><span class="o">/</span><span class="n">ready</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
  
<span class="n">server</span> <span class="p">{</span>
        <span class="n">listen</span> <span class="mi">89</span> <span class="n">http2</span><span class="p">;</span>
 
        <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
            <span class="n">grpc_pass</span> <span class="n">grpc</span><span class="p">:</span><span class="o">//</span><span class="n">backendgrpc</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
  
<span class="n">server</span> <span class="p">{</span>
    <span class="n">listen</span> <span class="mi">8080</span><span class="p">;</span>
    <span class="n">root</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">html</span><span class="p">;</span>
    <span class="n">location</span> <span class="o">=</span> <span class="o">/</span><span class="n">dashboard</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="p">}</span>
    <span class="n">location</span> <span class="o">=</span> <span class="o">/</span> <span class="p">{</span>
       <span class="k">return</span> <span class="mi">302</span> <span class="o">/</span><span class="n">dashboard</span><span class="o">.</span><span class="n">html</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">location</span> <span class="o">/</span><span class="n">api</span> <span class="p">{</span>
      <span class="n">api</span> <span class="n">write</span><span class="o">=</span><span class="n">on</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> 
</pre></div>
</div>
<p>​	最后，在<code class="docutils literal notranslate"><span class="pre">nginxplus-rc.yml</span></code>文件中，为NGINX Plus创建一个ReplicationController。要从私有注册表中提取镜像，Kubernetes需要凭据(credentials)。配置文件中的<code class="docutils literal notranslate"><span class="pre">imagePullSecrets</span></code>字段指定Kubernetes应该从名为regcred的Secret中获取凭据。在这个配置文件中，还必须将上一步创建的NGINX配置文件挂载到<code class="docutils literal notranslate"><span class="pre">/etc/nginx/conf.d</span></code>下。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
 <span class="n">kind</span><span class="p">:</span> <span class="n">ReplicationController</span>
 <span class="n">metadata</span><span class="p">:</span>
   <span class="n">name</span><span class="p">:</span> <span class="n">nginxplus</span><span class="o">-</span><span class="n">rc</span>
 <span class="n">spec</span><span class="p">:</span>
   <span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>
   <span class="n">selector</span><span class="p">:</span>
     <span class="n">app</span><span class="p">:</span> <span class="n">nginxplus</span>
   <span class="n">template</span><span class="p">:</span>
     <span class="n">metadata</span><span class="p">:</span>
       <span class="n">labels</span><span class="p">:</span>
         <span class="n">app</span><span class="p">:</span> <span class="n">nginxplus</span>
     <span class="n">spec</span><span class="p">:</span>
       <span class="n">nodeSelector</span><span class="p">:</span>
         <span class="n">role</span><span class="p">:</span> <span class="n">nginxplus</span>
       <span class="n">imagePullSecrets</span><span class="p">:</span>
       <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">regcred</span>
       <span class="n">containers</span><span class="p">:</span>
       <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginxplus</span>
         <span class="n">command</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;/bin/bash&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span> <span class="p">]</span>
         <span class="n">args</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;nginx; while true; do sleep 30; done;&quot;</span> <span class="p">]</span>
         <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
         <span class="n">image</span><span class="p">:</span> <span class="n">nvcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">nvidian</span><span class="o">/</span><span class="n">swdl</span><span class="o">/</span><span class="n">nginxplus</span><span class="p">:</span><span class="n">v1</span>
         <span class="n">ports</span><span class="p">:</span>
           <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
             <span class="n">containerPort</span><span class="p">:</span> <span class="mi">80</span>
             <span class="n">hostPort</span><span class="p">:</span> <span class="mi">8085</span>
           <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">grpc</span>
             <span class="n">containerPort</span><span class="p">:</span> <span class="mi">89</span>
             <span class="n">hostPort</span><span class="p">:</span> <span class="mi">8087</span>
           <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span><span class="o">-</span><span class="n">alt</span>
             <span class="n">containerPort</span><span class="p">:</span> <span class="mi">8080</span>
             <span class="n">hostPort</span><span class="p">:</span> <span class="mi">8086</span>
           <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">flower</span><span class="o">-</span><span class="n">svc</span>
             <span class="n">containerPort</span><span class="p">:</span> <span class="mi">8000</span>
             <span class="n">hostPort</span><span class="p">:</span> <span class="mi">32309</span>
         <span class="n">volumeMounts</span><span class="p">:</span>
           <span class="o">-</span> <span class="n">mountPath</span><span class="p">:</span> <span class="s2">&quot;/etc/nginx/conf.d&quot;</span>
             <span class="n">name</span><span class="p">:</span> <span class="n">etc</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">confd</span>
       <span class="n">volumes</span><span class="p">:</span>
         <span class="o">-</span> <span class="n">nfs</span><span class="p">:</span>
            <span class="n">server</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">NFS</span> <span class="n">server</span> <span class="n">IP</span><span class="o">&gt;</span>
            <span class="n">path</span><span class="p">:</span> <span class="o">&lt;/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">config</span><span class="o">&gt;</span>
            <span class="n">readOnly</span><span class="p">:</span> <span class="n">false</span>
           <span class="n">name</span><span class="p">:</span> <span class="n">etc</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">confd</span> 
</pre></div>
</div>
<p>​	使用以下命令创建ReplicationController：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginxplus</span><span class="o">-</span><span class="n">rc</span><span class="o">.</span><span class="n">yml</span>  
</pre></div>
</div>
<p>验证Deployment，可以看到NGINX Plus正在运行</p>
<p>现在，当客户端向服务器发送推理请求时，可以看到NGINX Plus Dashboard：</p>
<ul class="simple">
<li><p>自动缩放器的数量从一个逐渐增加到七个</p></li>
<li><p>工作负载在所有Pod之间均匀分布，如Traffic中所示</p></li>
</ul>
<p>还可以通过检查Prometheus中所有Pods的度量值或自定义度量值来确认新添加的Pods处于工作状态</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="01%E5%9C%A8Ubuntu18.04%E4%B8%8A%E6%90%AD%E5%BB%BAkubernetes.html" class="btn btn-neutral float-left" title="一、kubernetes安装" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="03%E4%BD%BF%E7%94%A8Kubernetes%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4.html" class="btn btn-neutral float-right" title="验收集群" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2023, 李仲亮.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>